# 挪车系统位置流程优化设计

## 背景

当前系统存在以下问题：
1. **恶意骚扰** - 有人故意反复扫码骚扰车主
2. **隐私泄露** - 车主位置在确认前就被获取
3. **误扫** - 路人好奇扫码但并不需要挪车

## 设计目标

- 通过位置验证确保请求者确实在车旁
- 保护车主隐私，确认后才分享位置
- 对无位置请求增加延迟，降低恶意骚扰动力

---

## 请求者端流程

### 1. 进入页面

```
┌─────────────────────────────────┐
│           🚗                    │
│       呼叫车主挪车               │
│                                 │
│  ┌─────────────────────────┐   │
│  │ 输入留言给车主...        │   │
│  │ [🚧挡路] [⏱️临停] ...    │   │
│  └─────────────────────────┘   │
│                                 │
│  ┌─────────────────────────┐   │
│  │ 📍 我的位置              │   │
│  │ ✅ 已获取位置            │   │  ← 自动获取
│  │ 或                       │   │
│  │ ⚠️ 未获取位置 [分享位置] │   │  ← 失败时显示按钮
│  └─────────────────────────┘   │
│                                 │
│  [🔔 一键通知车主]              │
└─────────────────────────────────┘
```

**自动获取位置：**
- 页面加载时自动请求位置授权
- 成功 → 显示"已获取位置 ✓"
- 失败/拒绝 → 显示"未获取位置"，并显示"分享位置"按钮

**分享位置按钮：**
- 始终可点击
- 点击后重新请求位置授权

### 2. 点击"一键通知车主"

**有位置：** 立即发送通知

**无位置：** 弹出询问框

```
┌─────────────────────────────────┐
│                                 │
│  📍 是否分享您的位置？           │
│                                 │
│  分享位置可让车主确认您在车旁，   │
│  不分享将延迟30秒发送            │
│                                 │
│  [分享位置]    [不分享，继续]    │
│                                 │
└─────────────────────────────────┘
```

- **分享位置** → 请求位置授权
  - 成功 → 立即发送
  - 失败 → 保持弹窗，可再次尝试
- **不分享，继续** → 30秒后发送

### 3. 等待页面

```
┌─────────────────────────────────┐
│              ✅                 │
│         通知已发送！             │
│    正在等待车主回应...           │
│                                 │
│  ┌─────────────────────────┐   │  ← 车主确认后显示
│  │ 🎉 车主已收到通知        │   │
│  │ 正在赶来，点击查看位置    │   │
│  │ [🗺️高德地图] [🍎Apple]  │   │  ← 如果车主分享了位置
│  └─────────────────────────┘   │
│                                 │
│  [🔔 再次通知]  [📞 直接打电话]  │
└─────────────────────────────────┘
```

---

## 车主端流程

### 1. 收到推送通知

| 请求类型 | 推送时机 |
|---------|---------|
| 有位置 | 立即推送 |
| 无位置 | 延迟30秒推送 |

通知内容：
- 🚗 挪车请求
- 💬 留言内容
- 📍 位置状态（已附带位置 / 未提供位置）

### 2. 进入确认页面

```
┌─────────────────────────────────┐
│              👋                 │
│        收到挪车请求              │
│     对方正在等待，请尽快确认      │
│                                 │
│  ┌─────────────────────────┐   │  ← 如果请求者分享了位置
│  │ 📍 对方位置              │   │
│  │ [🗺️高德地图] [🍎Apple]  │   │
│  └─────────────────────────┘   │
│                                 │
│  [🚀 我已知晓，正在前往]         │
└─────────────────────────────────┘
```

**注意：** 此时不自动获取车主位置

### 3. 点击"我已知晓，正在前往"

**自动请求车主位置授权**

**成功：**
- 发送确认 + 车主位置
- 显示"已通知对方您正在赶来"

**失败：** 弹出询问框

```
┌─────────────────────────────────┐
│                                 │
│  ⚠️ 位置获取失败                │
│                                 │
│  是否重新获取？                  │
│                                 │
│  [重新获取]    [跳过，直接确认]  │
│                                 │
└─────────────────────────────────┘
```

- **重新获取** → 再次请求位置授权（确认暂不发送）
- **跳过，直接确认** → 发送确认，不带位置

---

## 技术实现要点

### 后端 API 修改

**POST /api/notify**
- 新增参数：`hasLocation: boolean`
- 无位置时，使用 `setTimeout` 或 Cloudflare Durable Objects 延迟30秒后推送

### 前端修改

**请求者页面 (renderMainPage)**
- 添加位置状态提示和分享按钮
- 发送前检查位置，无位置时弹窗询问
- 实现30秒延迟发送逻辑

**车主页面 (renderOwnerPage)**
- 移除页面加载时的自动定位
- 点击确认时请求位置
- 失败时弹窗询问是否重试

### KV 存储

无需修改，现有结构支持：
- `requester_location` - 请求者位置
- `owner_location` - 车主位置
- `notify_status` - 通知状态

---

## 流程图

```
请求者                              车主
  │                                  │
  ├─ 进入页面，自动获取位置            │
  │                                  │
  ├─ 点击发送                         │
  │   ├─ 有位置 → 立即推送 ──────────→ 收到通知
  │   └─ 无位置 → 询问是否分享         │
  │       ├─ 分享 → 获取成功 → 立即推送 ──→ 收到通知
  │       └─ 不分享 → 30秒后推送 ────→ 收到通知
  │                                  │
  ├─ 等待中...                        ├─ 查看请求者位置
  │                                  │
  │                                  ├─ 点击确认
  │                                  │   ├─ 自动获取位置
  │                                  │   ├─ 成功 → 发送确认+位置
  │                                  │   └─ 失败 → 询问重试
  │                                  │       ├─ 重试 → 再次获取
  │                                  │       └─ 跳过 → 发送确认
  │                                  │
  ├─ 收到确认，显示车主位置 ←──────────┤
  │                                  │
  ▼                                  ▼
```

---

## 安全性提升

| 措施 | 效果 |
|------|------|
| 无位置延迟30秒 | 降低恶意扫码动力 |
| 车主可查看请求者位置 | 判断请求真实性 |
| 车主确认后才分享位置 | 保护车主隐私 |
| 明确的位置分享选择 | 用户知情同意 |
